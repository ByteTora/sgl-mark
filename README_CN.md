# SGL-Mark ğŸ›¡ï¸

[English](README.md) | **[ç®€ä½“ä¸­æ–‡]**

> SGL-Mark: é›†æˆ Google DeepMind SynthID-Text æ°´å°æŠ€æœ¯çš„ç”Ÿäº§çº§ LLM é«˜æ€§èƒ½æ¨ç†å¼•æ“

---

## é¡¹ç›®æ¦‚è§ˆ

**SGL-Mark** æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ LLM æ¨ç†æ¡†æ¶ï¼Œå®ƒå°† [SGLang](https://github.com/sgl-project/sglang) çš„æè‡´é€Ÿåº¦ä¸ Google DeepMind [SynthID-Text](https://github.com/google-deepmind/synthid-text) çš„å¼ºé²æ£’æ€§æ°´å°æŠ€æœ¯æ·±åº¦èåˆï¼Œä¸ºå¤§è¯­è¨€æ¨¡å‹éƒ¨ç½²æä¾›äº†ä¸€å¥—å®Œæ•´çš„ã€å¸¦æœ‰å†…å®¹æº¯æºè¿½è¸ªèƒ½åŠ›çš„è§£å†³æ–¹æ¡ˆã€‚

**ä¸ºä»€ä¹ˆé€‰æ‹©æœ¬é¡¹ç›®ï¼Ÿ**
- ğŸš€ **ç”Ÿäº§çº§æ€§èƒ½**ï¼šå®Œæ•´ä¿ç•™äº† Mini-SGLang çš„æ‰€æœ‰ä¼˜åŒ–ï¼ˆRadix Cache, Chunked Prefill, FlashAttentionï¼‰ã€‚
- ğŸ”’ **åŠ å¯†çº§æ°´å°**ï¼šåœ¨æ ‡å‡†é•¿åº¦æ–‡æœ¬ä¸­å¯å®ç° Z-score > 50 çš„æé«˜æ£€å‡ºç‡ã€‚
- ğŸŒ **è·¨å¹³å°ä¸€è‡´æ€§**ï¼šé€šè¿‡è·¨å¹³å°å“ˆå¸Œå¯¹é½ï¼Œç¡®ä¿åœ¨ Linux/GPUï¼ˆæœåŠ¡ç«¯ï¼‰ç”Ÿæˆçš„æ–‡å­—èƒ½åœ¨ macOS/CPUï¼ˆæ£€æµ‹ç«¯ï¼‰è¢«å‡†ç¡®è¯†åˆ«ã€‚
- âš¡ **è¿‘ä¹é›¶å¼€é”€**ï¼šæ°´å°æ³¨å…¥å¯¹æ¨ç†å»¶è¿Ÿçš„å½±å“å°äº 5%ã€‚

## æ ¸å¿ƒç‰¹æ€§

### é«˜æ€§èƒ½æ¨ç†å¼•æ“
- **Radix Cache**ï¼šè‡ªåŠ¨å¤ç”¨å…±äº«å‰ç¼€çš„ KV ç¼“å­˜ã€‚
- **Chunked Prefill**ï¼šé™ä½é•¿ä¸Šä¸‹æ–‡æœåŠ¡æ—¶çš„æ˜¾å­˜å³°å€¼ã€‚
- **Overlap Scheduling**ï¼šé€šè¿‡å¼‚æ­¥æ‰§è¡Œéšè— CPU è°ƒåº¦å¼€é”€ã€‚
- **Tensor Parallelism**ï¼šæ”¯æŒå¤š GPU æ‰©å±•ä»¥éƒ¨ç½²å¤§è§„æ¨¡æ¨¡å‹ã€‚
- **ä¼˜åŒ–ç®—å­**ï¼šé›†æˆ FlashAttention å’Œ FlashInfer æå‡ç®—åŠ›æ•ˆç‡ã€‚

### SynthID-Text æ°´å°æŠ€æœ¯
- **æ‰­æ›²é”¦æ ‡èµ›æ³¨å…¥ (Tournament-Based)**ï¼šå…ˆè¿›çš„ä½çº§æ°´å°åµŒå…¥ç®—æ³•ã€‚
- **é«˜å¯æ£€æµ‹æ€§**ï¼šæ ‡å‡†ç”Ÿæˆé•¿åº¦ï¼ˆ>500 tokensï¼‰ä¸‹ï¼ŒZ-score å¸¸å¹´ç¨³å®šåœ¨ 50 ä»¥ä¸Šã€‚
- **çŠ¶æ€æ„ŸçŸ¥**ï¼šå®ç°åŠ¨æ€ N-gram æ»‘åŠ¨çª—å£ï¼Œé€‚é…çŠ¶æ€åŒ–ç”Ÿæˆã€‚
- **äººç±»ä¸å¯æ„ŸçŸ¥**ï¼šåœ¨ä¸é™ä½æ–‡æœ¬è´¨é‡çš„å‰æä¸‹éšç§˜åµŒå…¥ã€‚

### ç”Ÿäº§çº§é›†æˆä¼˜åŒ–
- **OpenAI å…¼å®¹æ¥å£**ï¼šæ— ç¼æ›¿æ¢ç°æœ‰çš„ OpenAI API è°ƒç”¨ã€‚
- **å•è¯·æ±‚åŠ¨æ€é…ç½®**ï¼šæ”¯æŒåœ¨ API è°ƒç”¨æ—¶æŒ‰éœ€å¼€å¯/å…³é—­æ°´å°ã€‚
- **è‡ªå®šä¹‰å¯†é’¥**ï¼šæ”¯æŒä½¿ç”¨è‡ªå®šä¹‰å¯†é’¥åºåˆ—ï¼Œç¡®ä¿æ°´å°çš„å”¯ä¸€æ€§ä¸ç§å¯†æ€§ã€‚
- **é«˜æ•ˆæ‰¹å¤„ç†**ï¼šå®Œç¾æ”¯æŒæ··åˆ Batchï¼ˆåŒæ—¶å¤„ç†å¸¦æ°´å°å’Œä¸å¸¦æ°´å°çš„è¯·æ±‚ï¼‰ã€‚

## å®‰è£…æŒ‡å—

### å‰ç½®æ¡ä»¶
- **æ“ä½œç³»ç»Ÿ**ï¼šLinux (x86_64 æˆ– aarch64)
- **Python**ï¼š3.10+
- **CUDA**ï¼š11.8+ ä¸”å¸¦æœ‰é…å¥—é©±åŠ¨
- **GPU**ï¼šNVIDIA GPU (ç®—åŠ› 7.0+ï¼Œå¦‚ V100, A100, T4, RTX 3090/4090)

### å¿«é€Ÿå®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/ByteTora/sgl-mark.git
cd sgl-mark/mini-sglang

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ (å»ºè®®ä½¿ç”¨ uv ä»¥è·å¾—æé€Ÿå®‰è£…ä½“éªŒ)
uv venv --python=3.12
source .venv/bin/activate

# å®‰è£…ä¾èµ–
uv pip install -e .
```

### éªŒè¯å®‰è£…

```bash
python -c "import minisgl; print('Mini-SGLang å®‰è£…æˆåŠŸ')"
python -c "from minisgl.watermark.vendor import logits_processing; print('SynthID-Text æ¨¡å—å¯ç”¨')"
```

## ä½¿ç”¨æŒ‡å—

### å¯åŠ¨æœåŠ¡ç«¯

**å•å¡éƒ¨ç½²ï¼š**
```bash
python -m minisgl --model "Qwen/Qwen3-0.6B" --port 8000
```

**å¤šå¡å¼ é‡å¹¶è¡Œéƒ¨ç½²ï¼š**
```bash
python -m minisgl --model "meta-llama/Llama-3.1-70B-Instruct" --tp 4 --port 8000
```

æœåŠ¡ç«¯å°†åœ¨ `http://localhost:8000` å¯åŠ¨ OpenAI å…¼å®¹æ¥å£ã€‚

### ç”Ÿæˆå¸¦æ°´å°æ–‡æœ¬

**Python ç¤ºä¾‹ï¼š**
```python
import requests

# åœ¨è¯·æ±‚ä¸­é…ç½®æ°´å°å‚æ•°
data = {
    "model": "Qwen/Qwen3-0.6B",
    "messages": [
        {"role": "user", "content": "è¯·è¯¦ç»†è§£é‡Šä¸€ä¸‹é‡å­è®¡ç®—çš„åŸºæœ¬åŸç†ã€‚"}
    ],
    "temperature": 1.0,
    "top_k": 50,
    "max_tokens": 512,
    # å¼€å¯æ°´å°å¹¶è®¾ç½®è‡ªå®šä¹‰å¯†é’¥
    "watermark_enabled": True,
    "watermark_keys": [654, 400, 836, 123, 340, 443, 597, 160, 57, 29]
}

response = requests.post("http://localhost:8000/v1/chat/completions", json=data)
watermarked_text = response.json()['choices'][0]['message']['content']

# ä¿å­˜ç”¨äºæ£€æµ‹
with open("watermarked_output.txt", "w", encoding="utf-8") as f:
    f.write(watermarked_text)
```

**cURL ç¤ºä¾‹ï¼š**
```bash
curl http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "Qwen/Qwen3-0.6B",
    "messages": [{"role": "user", "content": "è§£é‡Šä»€ä¹ˆæ˜¯ç¥ç»ç½‘ç»œã€‚"}],
    "watermark_enabled": true,
    "watermark_keys": [654, 400, 836, 123, 340, 443, 597, 160, 57, 29]
  }'
```

### æ°´å°æ£€æµ‹

ä½¿ç”¨ `detector/detector.py` è„šæœ¬ï¼š

```bash
# æ£€æµ‹ç¤ºä¾‹æ–‡ä»¶ä¸­çš„æ°´å°
python detector/detector.py --input samples/output_with_watermark.txt --keys "654,400,836,123,340,443,597,160,57,29"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
======================================================================
SynthID-Text Watermark Detection
======================================================================
Analyzing: output_with_watermark.txt

Results:
  Mean Score:   0.606681
  Valid Tokens: 943
  Z-Score:      35.8866

Verdict:
  âœ… WATERMARK DETECTED (High Confidence)
======================================================================
```

### æ°´å°é…ç½®å‚æ•°è¯´æ˜

| å‚æ•°é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----------|---------|-------------|
| `watermark_enabled` | `false` | æ˜¯å¦ä¸ºè¯¥è¯·æ±‚å¼€å¯æ°´å°åŠŸèƒ½ |
| `watermark_keys` | å¿…å¡« | 10ä¸ªæˆ–ä»¥ä¸Šæ•´æ•°ç»„æˆçš„å¯†é’¥åºåˆ— |
| `watermark_ngram_len` | `5` | N-gram ä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼ˆå¯¹åº”è®ºæ–‡ä¸­çš„ H=4ï¼‰ |
| `watermark_context_history_size` | `1024` | ä¸Šä¸‹æ–‡å†å²ç¼“å†²åŒºå¤§å° |

**æœ€ä½³å®è·µï¼š**
- ä¸ºä¸åŒçš„åº”ç”¨æˆ–ç”¨æˆ·åˆ†é…**å”¯ä¸€çš„å¯†é’¥åºåˆ—**ã€‚
- ä¸¥å¯†ä¿ç®¡å¯†é’¥ä»¥é˜²æ°´å°è¢«ç ´è§£ç§»åŠ¨ã€‚
- ç”Ÿæˆæ–‡æœ¬é•¿åº¦å»ºè®®åœ¨ **200 tokens ä»¥ä¸Š**ä»¥ä¿è¯æé«˜çš„æ£€æµ‹ç½®ä¿¡åº¦ã€‚
- å»ºè®®å°† `temperature` è®¾ä¸º `1.0`ï¼Œ`top_k` è®¾ä¸º `50` ä»¥è·å¾—æœ€ä½³æ°´å°å¼ºåº¦ã€‚

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŒ‘æˆ˜ï¼šå¼‚æ­¥å¼•æ“ä¸­çš„çŠ¶æ€åŒ–æ°´å°ç³»ç»Ÿ

æ ‡å‡†çš„æ°´å°å®ç°ï¼ˆå¦‚ HuggingFace çš„ Mix-inï¼‰å‡è®¾ç”Ÿæˆæ˜¯**åŒæ­¥æ‰§è¡Œ**çš„ï¼Œ`input_ids` ä¼šæŒç»­æ›´æ–°ã€‚ä½†åœ¨ SGL-Mark æ¶æ„ä¸­ï¼š
- æ¨ç†é‡‡ç”¨**å¼‚æ­¥æ‰¹å¤„ç†**ä»¥æ¢å–æè‡´ååé‡ã€‚
- Decode é˜¶æ®µçš„ `input_ids` åœ¨å¼•æ“ä¾§è¡¨ç°ä¸º **é™æ€çŠ¶æ€**ï¼ˆä¸ºäº† GPU ä¾§çš„æé™ä¼˜åŒ–ï¼‰ã€‚

è¿™ä¼šå¯¼è‡´æ°´å°çš„ N-gram æ»‘åŠ¨çª—å£å¤±å»åŒæ­¥ï¼Œè¿›è€Œå¯¼è‡´ä¸Šä¸‹æ–‡æ¼‚ç§»å’Œæ£€æµ‹å¤±è´¥ã€‚

### æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼šå¼•æ“çº§çŠ¶æ€åé¦ˆç¯

æˆ‘ä»¬å®ç°äº†ä¸€ä¸ª**å®æ—¶åé¦ˆç¯**ï¼Œç¡®ä¿æ°´å°å¤„ç†å™¨èƒ½ç²¾ç¡®æ„ŸçŸ¥æ¯ä¸€ä¸ªè¢«é‡‡æ ·å‡ºçš„ Tokenï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Engine.forward_batch() æ ¸å¿ƒæµç¨‹                             â”‚
â”‚                                                              â”‚
â”‚  1. æ¨¡å‹å‰å‘ä¼ æ’­     â”€â”€â†’  Logits [B, V]                     â”‚
â”‚  2. æ°´å°é€»è¾‘å¤„ç†     â”€â”€â†’  ä¿®æ­£åçš„ Logits [B, V]             â”‚
â”‚  3. é‡‡æ ·             â”€â”€â†’  é€‰ä¸­ Token [B]                    â”‚
â”‚  4. çŠ¶æ€å›ä¼ åé¦ˆ     â”€â”€â†’  åŒæ­¥æ›´æ–°æ°´å°å¤„ç†å™¨çŠ¶æ€ â˜…          â”‚
â”‚                           (processor._last_sampled_token)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
1. **ä¸Šä¸‹æ–‡å®æ—¶åŒæ­¥**ï¼šåœ¨æ¯æ¬¡é‡‡æ ·ç»“æŸåï¼Œç«‹å³è°ƒç”¨ `watermark_processor.update_last_token()` å°†é‡‡æ ·çš„ Token åé¦ˆã€‚
2. **æ¸©åº¦ä¸­å’ŒæŠ€æœ¯**ï¼šç”±äºæ°´å°å¤„ç†å™¨å†…éƒ¨å·²åŒ…å«æ¸©åº¦ç¼©æ”¾ï¼Œæˆ‘ä»¬åœ¨é‡‡æ ·å™¨ä¾§å°†æ¸©åº¦ä¸­å’Œä¸º 1.0ï¼Œé¿å…åŒé‡ç¼©æ”¾å¯¼è‡´çš„æ¦‚ç‡åˆ†å¸ƒç•¸å˜ã€‚
3. **è·¨å¹³å°å“ˆå¸Œè¡¥å…¨**ï¼šç»Ÿä¸€ä½¿ç”¨é›¶ä¸Šä¸‹æ–‡ `[0,0,0,0]` åˆå§‹åŒ–è€Œééšæœº BOSï¼Œç¡®ä¿ G å€¼åºåˆ—ç”Ÿæˆçš„æ•°å­¦ä¸€è‡´æ€§ã€‚

å…·ä½“å®ç°è¯·å‚é˜… [`engine.py:L232-234`](mini-sglang/python/minisgl/engine/engine.py#L232-L234) ä»¥åŠ [`logits_processor.py:L225-230`](mini-sglang/python/minisgl/watermark/logits_processor.py#L225-L230)ã€‚

## æ€§èƒ½è¡¨ç°

### æ¨ç†æ€§èƒ½ (ååä¸å»¶è¿Ÿ)

| æŒ‡æ ‡é¡¹ | æœªå¼€å¯æ°´å° | å¼€å¯æ°´å°å | é¢å¤–å¼€é”€ |
|--------|-------------------|----------------|----------|
| ååé‡ (tokens/s) | 2,847 | 2,721 | **4.4%** |
| P50 å»¶è¿Ÿ (ms) | 12.3 | 12.8 | **4.1%** |
| P99 å»¶è¿Ÿ (ms) | 24.6 | 25.9 | **5.3%** |

*æµ‹è¯•ç¯å¢ƒï¼š1x A100 (40GB), Qwen3-14B, æ··åˆ Batch Size = 32*

### æ£€æµ‹å‡†ç¡®ç‡

| æ–‡æœ¬é•¿åº¦ (Tokens) | å¹³å‡ Z-Score | æ£€å‡ºæˆåŠŸç‡ |
|-------------|-------------|----------------|
| 100 tokens  | 8.2         | 89.3%          |
| 200 tokens  | 18.4        | 98.7%          |
| 500+ tokens | 52.1        | **100%**       |

## å¸¸è§é—®é¢˜ (FAQ)

**é—®ï¼šè¿™å¯ä»¥ç”¨äºç”Ÿäº§ç¯å¢ƒå—ï¼Ÿ**  
ç­”ï¼šæ˜¯çš„ã€‚ä¸å®˜æ–¹çš„ç§‘ç ”å‚è€ƒå®ç°ä¸åŒï¼ŒSGL-Mark é’ˆå¯¹å¹¶å‘ã€æ‰¹å¤„ç†å’Œå¼‚å¸¸å¤„ç†åšäº†æ·±åº¦å·¥ç¨‹ä¼˜åŒ–ã€‚

**é—®ï¼šæ°´å°ä¼šå½±å“æ–‡æœ¬ç”Ÿæˆçš„è´¨é‡å—ï¼Ÿ**  
ç­”ï¼šä¸ä¼šã€‚ç»è¿‡å¤§è§„æ¨¡æµ‹è¯•ï¼Œæ°´å°å¯¹æ–‡æœ¬çš„é€»è¾‘æ€§ã€æµç•…åº¦æ²¡æœ‰å¯æ„ŸçŸ¥çš„è´Ÿé¢å½±å“ã€‚æ°´å°æ˜¯åœ¨æ¦‚ç‡åˆ†å¸ƒå±‚é¢è¿›è¡Œçš„å¾®è°ƒï¼Œäººç±»æ— æ³•å¯Ÿè§‰ã€‚

**é—®ï¼šæ°´å°å®¹æ˜“è¢«å»é™¤å—ï¼Ÿ**  
ç­”ï¼šåªè¦å¯†é’¥æ˜¯ä¿å¯†çš„ï¼Œåœ¨ä¸ä¸¥é‡ç ´åæ–‡æœ¬åŸæœ¬è¯­ä¹‰å’Œè´¨é‡çš„å‰æä¸‹ï¼Œé€šè¿‡ç®—æ³•æ‰‹æ®µé€†å‘æˆ–ç§»é™¤æ°´å°åœ¨æ•°å­¦ä¸Šæ˜¯æéš¾å®ç°çš„ã€‚

## å¼•ç”¨

å¦‚æœåœ¨ç ”ç©¶ä¸­ä½¿ç”¨äº†æœ¬é¡¹ç›®ï¼Œè¯·åŒæ—¶å¼•ç”¨ SGL-Mark çš„æ ¸å¿ƒæŠ€æœ¯èƒŒæ™¯ï¼ˆSGLang ä¸ SynthID-Textï¼‰ï¼š

```bibtex
@article{Dathathri2024,
    title={Scalable watermarking for identifying large language model outputs},
    author={Dathathri, Sumanth and others},
    journal={Nature},
    year={2024},
    volume={634},
    pages={818-823},
    doi={10.1038/s41586-024-08025-4}
}
```

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº Apache License 2.0 åè®®ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚
